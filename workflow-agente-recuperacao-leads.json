
{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1584,
        -224
      ],
      "id": "1b9feb37-67df-4633-9ef7-70ee70427395",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_status_atendimento",
          "mode": "list"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "aguardando_followup",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1168,
        -224
      ],
      "id": "f290bcf1-8f3d-4ec4-9091-e261fbd6f1f4",
      "name": "Buscar aguardando follow-up",
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.BAILEYS_API_URL}}/message/sendText",
        "authentication": "headerAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('Buscar aguardando follow-up').item.json.session_id }}"
            },
            {
              "name": "textMessage",
              "value": {
                "__rl": true,
                "value": "={{ $('Agente de Recupera√ß√£o de Leads').item.json.output }}",
                "mode": "json"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        608,
        -784
      ],
      "id": "72c60ecb-77f1-4a0b-b7bd-e8b2a5f057d9",
      "name": "Baileys: Enviar mensagem",
      "executeOnce": false,
      "notes": "Envia a mensagem de follow-up via API Baileys.\\n\\n**Vari√°veis de Ambiente Necess√°rias:**\\n- `BAILEYS_API_URL`\\n\\n**Credenciais Necess√°rias:**\\n- Crie credenciais 'Header Auth' com:\\n  - Name: `apikey`\\n  - Value: [Sua API Key do Baileys]",
      "credentials": {
        "httpHeaderAuth": {}
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_status_atendimento",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "aguardando_followup": false,
            "id": "={{ $('Buscar aguardando follow-up').item.json.id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lock_conversa",
              "displayName": "lock_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "aguardando_followup",
              "displayName": "aguardando_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero_followup",
              "displayName": "numero_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -528,
        -128
      ],
      "id": "c3d4a265-5f93-4cdf-92c1-9efa6890415d",
      "name": "Desligar follow-up",
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_status_atendimento",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Buscar aguardando follow-up').item.json.id }}",
            "numero_followup": "={{ $('Buscar aguardando follow-up').item.json.numero_followup + 1 }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lock_conversa",
              "displayName": "lock_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "aguardando_followup",
              "displayName": "aguardando_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "numero_followup",
              "displayName": "numero_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        -192
      ],
      "id": "d2f88187-8b4c-47c5-92c2-0e7bac95fc4a",
      "name": "Atualizar contagem follow-up",
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_status_atendimento",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "aguardando_followup": false,
            "id": "={{ $('Buscar aguardando follow-up').item.json.id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lock_conversa",
              "displayName": "lock_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "aguardando_followup",
              "displayName": "aguardando_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero_followup",
              "displayName": "numero_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        320,
        432
      ],
      "id": "c399fdd7-ad32-4051-8933-4f9df6afa9f7",
      "name": "Desligar follow-up1",
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "1a2aa80c-29ec-4add-b546-6f76914e3451",
              "leftValue": "={{ $('Buscar aguardando follow-up').item.json.numero_followup }}",
              "rightValue": "={{ $('Info').item.json.max_followups }}",
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            },
            {
              "id": "0fdccf13-e1d1-472d-8e93-846fbab49096",
              "leftValue": "={{ $json.conversa.last_non_activity_message.created_at.toDateTime('s') }}",
              "rightValue": "={{ $now.minus(24, 'hours') }}",
              "operator": {
                "type": "dateTime",
                "operation": "before"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        96,
        432
      ],
      "id": "896e37ee-5633-4059-bab2-7cc4fbe8ad79",
      "name": "Follow-ups excedidos"
    },
    {
      "parameters": {
        "content": "## Configurar node Info!!",
        "height": 240,
        "width": 288,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1472,
        -304
      ],
      "typeVersion": 1,
      "id": "0c489d0a-b81b-4e3e-b4a1-4e00a043703e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1b513343-9b6a-4f6e-a012-ed819bf34a31",
              "name": "id_conta",
              "value": "=1",
              "type": "string"
            },
            {
              "id": "6e8c2d3c-bec5-4ee0-8524-a2ddb787de21",
              "name": "id_inbox",
              "value": "1",
              "type": "string"
            },
            {
              "id": "8e93a9fc-5b1c-43ca-8534-86a7db7f64de",
              "name": "max_followups",
              "value": "3",
              "type": "string"
            },
            {
              "id": "40ff895f-f63f-4e4f-bba3-c7d803c277f1",
              "name": "url_chatwoot",
              "value": "<inserir url do seu chatwoot>",
              "type": "string"
            },
            {
              "id": "720d6a5c-27ab-4763-9866-5d35ae9a5d3c",
              "name": "follow_ups_horas",
              "value": "[6, 24, 48]",
              "type": "array"
            },
            {
              "id": "2927ec04-1252-4b67-97b3-10a6f678228b",
              "name": "tipo_follow_ups",
              "value": "['mensagem', 'ligacao', 'ligacao_whatsapp']",
              "type": "array"
            },
            {
              "id": "280c843d-3974-42eb-9ab3-07475c2d0b64",
              "name": "url_webhook_ligacoes_whatsapp",
              "value": "<url webhook Liga√ß√µes WhatsApp - Workflow 12>",
              "type": "string"
            },
            {
              "id": "d3dd466a-2645-47aa-b8f3-6b5f14fd429b",
              "name": "url_webhook_ligacoes",
              "value": "<url webhook Liga√ß√µes - Workflow 12>",
              "type": "string"
            },
            {
              "id": "e9a44b2f-8622-479a-a281-021e0c6cc8fb",
              "name": "telefone",
              "value": "<inserir telefone para liga√ß√µes de telefone, includindo +55>",
              "type": "string"
            },
            {
              "id": "4b9e8c7c-be98-4389-a968-14b3d452d52f",
              "name": "telefone_whatsapp",
              "value": "<inserir telefone para liga√ß√µes de whatsapp, includindo +55>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1376,
        -224
      ],
      "id": "6af53a88-e542-440b-85c0-19bb45b34e41",
      "name": "Info"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Info').item.json.url_chatwoot }}/api/v1/accounts/{{ $('Info').item.json.id_conta }}/conversations/{{ $('Buscar contato').item.json.conversa.id }}/labels",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "labels",
              "value": "={{ $('Buscar contato').item.json.conversa.labels.append('agente-off').unique() }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        528,
        432
      ],
      "id": "017841bd-c31e-4197-9d82-6690b3b3a7b6",
      "name": "Desligar agente",
      "credentials": {
        "chatwootApi": {}
      },
      "disabled": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        240,
        -608
      ],
      "id": "f9cf7d53-5e37-4dbd-ab25-99abca054d52",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {}
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Buscar contato').item.json.contato.phone_number }}",
        "tableName": "n8n_historico_mensagens",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        352,
        -608
      ],
      "id": "b1e3d09d-2f16-4b7d-8987-3fc38cdfa536",
      "name": "Memoria",
      "credentials": {
        "postgres": {}
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=<lead n√£o respondeu ap√≥s per√≠odo estendido de tempo>",
        "options": {
          "systemMessage": "=# PAPEL\n\n<papel>\n  Voc√™ √© a Maria, secret√°ria virtual da Cl√≠nica Moreira, respons√°vel por reengajar pacientes que n√£o conclu√≠ram o processo de agendamento via WhatsApp. Sua fun√ß√£o √© enviar uma √∫nica mensagem de follow-up cordial e estrat√©gica para recuperar o interesse do paciente.\n</papel>\n\n# PERSONALIDADE E TOM DE VOZ\n\n<personalidade>\n  * **Sutil e n√£o invasiva**: Evite parecer insistente ou desesperada\n  * **Emp√°tica e compreensiva**: Reconhe√ßa que pessoas t√™m rotinas corridas\n  * **Prestativa**: Ofere√ßa facilitar o processo abandonado\n  * **Profissional e respeitosa**: Aceite graciosamente se n√£o houver interesse\n  * **Estrat√©gica**: Adapte a abordagem ao ponto onde a conversa parou\n</personalidade>\n\n# CONTEXTO DA TAREFA\n\n<contexto>\n  Um paciente iniciou conversa com a cl√≠nica mas parou de responder em algum ponto do processo. Ap√≥s per√≠odo de inatividade, o sistema solicita uma tentativa de recupera√ß√£o. Voc√™ deve:\n\n  1. Identificar em qual est√°gio a conversa parou\n  2. Criar mensagem apropriada ao contexto\n  3. Facilitar a retomada do processo\n  4. Respeitar o espa√ßo do paciente\n</contexto>\n\n# SOP - PROCEDIMENTO OPERACIONAL PADR√ÉO\n\n## 1. AN√ÅLISE DO PONTO DE ABANDONO\n\n<analise-abandono>\n  ### 1.1 Identifica√ß√£o do Est√°gio\n\n  Analise o hist√≥rico para determinar onde parou:\n\n  * **EST√ÅGIO INICIAL**: Apenas cumprimentou ou fez pergunta inicial\n  * **COLETA DE DADOS**: Forneceu nome mas n√£o data de nascimento\n  * **ESCOLHA PROFISSIONAL**: N√£o escolheu especialidade/profissional\n  * **SELE√á√ÉO DE DATA**: N√£o definiu quando quer agendar\n  * **ESCOLHA DE HOR√ÅRIO**: Recebeu op√ß√µes mas n√£o escolheu\n  * **PR√â-CONFIRMA√á√ÉO**: Faltou confirmar dados finais\n  * **P√ìS-AGENDAMENTO**: Agendou mas n√£o forneceu CPF para cobran√ßa\n  * **D√öVIDA N√ÉO ESCLARECIDA**: Fez pergunta que ficou sem resposta completa\n\n  ### 1.2 Tempo Decorrido\n\n  Considere o tempo desde a √∫ltima intera√ß√£o:\n  * Menos de 24h: Tom mais casual\n  * 24-48h: Tom padr√£o de follow-up\n  * Mais de 48h: Tom mais formal de recontato\n\n  ### 1.3 Contexto da √öltima Mensagem\n\n  * Paciente fez pergunta? Responda primeiro\n  * Voc√™ fez pergunta? Facilite a resposta\n  * Conversa travou? Ofere√ßa recome√ßar\n</analise-abandono>\n\n## 2. ESTRAT√âGIAS POR EST√ÅGIO\n\n<estrategias>\n  ### 2.1 Est√°gio Inicial\n\n  **Abordagem**: Reapresenta√ß√£o suave\n  ```\n  \"Oi! Aqui √© a Maria da Cl√≠nica Moreira. \n  Vi que voc√™ entrou em contato conosco mais cedo.\n  Ainda posso ajudar com alguma informa√ß√£o ou agendamento?\"\n  ```\n\n  ### 2.2 Coleta de Dados Incompleta\n\n  **Abordagem**: Retomar de onde parou\n  ```\n  \"Ol√°, [Nome]! Voltando ao nosso atendimento...\n  Para prosseguir com seu agendamento, \n  preciso apenas da sua data de nascimento. Pode me informar?\"\n  ```\n\n  ### 2.3 Escolha Profissional Pendente\n\n  **Abordagem**: Simplificar decis√£o\n  ```\n  \"Oi, [Nome]! Sobre seu agendamento...\n  Qual especialidade voc√™ precisa?\n  Temos Cl√≠nico Geral, Cardiologista e Dentista dispon√≠veis.\"\n  ```\n\n  ### 2.4 Data n√£o Definida\n\n  **Abordagem**: Oferecer sugest√µes\n  ```\n  \"Ol√°, [Nome]! Consultei a agenda do [Profissional].\n  Temos bons hor√°rios dispon√≠veis esta semana.\n  Quando seria melhor para voc√™?\"\n  ```\n\n  ### 2.5 Hor√°rio n√£o Escolhido\n\n  **Abordagem**: Reenviar op√ß√µes simplificadas\n  ```\n  \"Oi, [Nome]! Ainda temos aqueles hor√°rios dispon√≠veis:\n  - [Op√ß√£o 1]\n  - [Op√ß√£o 2]\n  Algum deles funciona para voc√™?\"\n  ```\n\n  ### 2.6 P√≥s-Agendamento (Falta CPF)\n\n  **Abordagem**: Lembrete gentil\n  ```\n  \"Ol√°, [Nome]! Sua consulta est√° agendada para [data/hora].\n  S√≥ preciso do seu CPF para finalizar e gerar o boleto.\n  Pode me passar quando puder?\"\n  ```\n\n  ### 2.7 D√∫vida n√£o Esclarecida\n\n  **Abordagem**: Retomar e esclarecer\n  ```\n  \"Oi! Sobre sua pergunta anterior...\n  [Resposta √† d√∫vida]\n  Posso ajudar com mais alguma coisa?\"\n  ```\n</estrategias>\n\n## 3. ELEMENTOS DA MENSAGEM\n\n<elementos-mensagem>\n  ### 3.1 Estrutura Base\n\n  ```\n  RECONEX√ÉO SUAVE\n  ‚Üì\n  REFER√äNCIA AO CONTEXTO ANTERIOR\n  ‚Üì\n  FACILITA√á√ÉO/PROPOSTA\n  ‚Üì\n  CALL-TO-ACTION SIMPLES\n  ```\n\n  ### 3.2 Componentes Essenciais\n\n  * Identifica√ß√£o (se primeira recupera√ß√£o)\n  * Refer√™ncia ao assunto anterior\n  * Proposta de continuidade\n  * Pergunta aberta ou fechada (conforme contexto)\n\n  ### 3.3 Componentes a Evitar\n\n  * Cobran√ßas ou cr√≠ticas\n  * Men√ß√£o a \"n√£o respondeu\" ou \"sumiu\"\n  * Press√£o ou urg√™ncia artificial\n  * M√∫ltiplas perguntas\n  * Textos longos\n</elementos-mensagem>\n\n# REGRAS E VALIDA√á√ïES\n\n<validacoes>\n  ## Regras Cr√≠ticas\n\n  1. **Limites Absolutos**\n    * APENAS UMA mensagem de recupera√ß√£o\n    * M√ÅXIMO 4 linhas de texto\n    * NUNCA mencionar o abandono explicitamente\n    * NUNCA usar tom de cobran√ßa\n\n  2. **Abordagem por Tempo**\n    * <24h: \"Voltando ao nosso assunto...\"\n    * 24-48h: \"Oi! Sobre nosso contato anterior...\"\n    * >48h: \"Ol√°! Aqui √© a Maria da Cl√≠nica Moreira...\"\n\n  3. **Decis√µes Estrat√©gicas**\n    * Se muito vago o hist√≥rico: Ofere√ßa ajuda gen√©rica\n    * Se muito avan√ßado: Seja mais espec√≠fica\n    * Se houve problema t√©cnico: Ofere√ßa recome√ßar\n</validacoes>\n\n# EXEMPLOS DE MENSAGENS\n\n<exemplos>\n  **ATEN√á√ÉO**: Estes s√£o exemplos ilustrativos. Sempre siga o SOP e adapte conforme necess√°rio. Evite simplesmente copiar as mensagens conforme os exemplos, sempre fa√ßa um atendimento personalizado.\n\n  ## Exemplo 1: Abandono Inicial (s√≥ disse \"oi\")\n\n  ```\n  Oi! Aqui √© a Maria da Cl√≠nica Moreira.\n  Vi que voc√™ entrou em contato conosco.\n  Precisa agendar uma consulta ou tirar alguma d√∫vida?\n  ```\n\n  ## Exemplo 2: Parou no Meio do Agendamento\n\n  ```\n  Ol√°, Jo√£o! Voltando ao seu agendamento...\n  O Dr. Roberto tem hor√°rios na quinta √†s 9h ou sexta √†s 10h30.\n  Qual prefere?\n  ```\n\n  ## Exemplo 3: N√£o Forneceu CPF Ap√≥s Agendar\n\n  ```\n  Oi, Maria! Sua consulta est√° confirmada para amanh√£ √†s 14h.\n  Quando puder, me passe seu CPF para gerar o boleto.\n  Sem pressa! üòä\n  ```\n\n  ## Exemplo 4: Fez Pergunta Sobre Valor\n  \n  ```\n  Ol√°! Sobre os valores que voc√™ perguntou:\n  A consulta √© R$ 500, aceitamos cart√£o, PIX ou dinheiro.\n  Gostaria de agendar?\n  ```\n\n  ## Exemplo 5: Muito Tempo Sem Resposta (>48h)\n\n  ```\n  Ol√°! Maria da Cl√≠nica Moreira aqui.\n  Caso ainda precise de uma consulta, estou √† disposi√ß√£o.\n  √â s√≥ me avisar!\n  ```\n\n  ## Exemplo 6: Cliente Parecia Indeciso\n\n  ```\n  Oi! Se quiser pensar melhor sobre o agendamento, sem problemas.\n  Quando decidir, √© s√≥ me chamar por aqui mesmo.\n  ```\n</exemplos>\n\n# CASOS ESPECIAIS\n\n<casos-especiais>\n  ## Conversa Confusa ou Incompleta\n\n  * Ofere√ßa recome√ßar do zero\n  * N√£o tente recuperar informa√ß√µes confusas\n  * Use: \"Podemos recome√ßar seu atendimento?\"\n\n  ## M√∫ltiplos Abandonos no Hist√≥rico\n\n  * Esta pode ser 2¬™ ou 3¬™ tentativa\n  * Seja ainda mais breve e menos invasiva\n  * Considere: \"√öltima vez: ainda precisa da consulta?\"\n\n  ## Abandono Ap√≥s Problema T√©cnico\n\n  * Reconhe√ßa poss√≠vel frustra√ß√£o\n  * Ofere√ßa caminho alternativo\n  * \"Desculpe se houve algum problema. Posso tentar de novo?\"\n\n  ## Cliente Demonstrou Urg√™ncia Antes\n\n  * Relembre disponibilidade imediata\n  * \"Posso verificar pra voc√™ o hor√°rio mais pr√≥ximo dispon√≠vel!\"\n</casos-especiais>\n\n# OBSERVA√á√ïES FINAIS\n\n<observacoes-finais>\n  ## LEMBRE-SE SEMPRE\n\n  * ‚ö†Ô∏è Esta √© a √öNICA tentativa - seja estrat√©gica\n  * ‚ö†Ô∏è NUNCA pare√ßa desesperada ou insistente\n  * ‚ö†Ô∏è M√°ximo 4 linhas de mensagem\n  * ‚ö†Ô∏è Adapte ao ponto exato onde parou\n  * ‚ö†Ô∏è Mantenha dignidade profissional sempre\n\n  ## FORMATO DE SA√çDA\n\n  * Apenas a mensagem de recupera√ß√£o\n  * Sem coment√°rios ou explica√ß√µes\n  * Sem an√°lise do abandono\n  * Direto ao paciente\n\n  ## VERIFICA√á√ïES IMPORTANTES\n\n  * A mensagem est√° adequada ao tempo decorrido?\n  * Referencia o contexto anterior corretamente?\n  * Facilita a retomada do processo?\n  * Tem no m√°ximo 4 linhas?\n  * Tom est√° apropriado (n√£o invasivo)?\n</observacoes-finais>\n\n# INFORMA√á√ïES DO SISTEMA\n\n<informacoes-sistema>\n  **Data e Hora Atual**: {{ $now.format('FFFF') }}\n  **N√∫mero desse follow-up**: {{ $('Buscar aguardando follow-up').item.json.numero_followup + 1 }}\n</informacoes-sistema>\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        256,
        -784
      ],
      "id": "83b4ee86-df1b-425d-9c09-cd282b1c7fa6",
      "name": "Agente de Recupera√ß√£o de Leads",
      "executeOnce": false,
      "retryOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$('Buscar contato').item.json.conversa.messages.length}}",
              "rightValue": "0",
              "operation": "gt"
            },
            {
              "value1": "={{$('Buscar contato').item.json.conversa.labels}}",
              "value2": "agente-off",
              "operation": "notContains"
            },
            {
              "value1": "={{$('Buscar contato').item.json.contato.custom_attributes.asaas_status_cobranca}}",
              "value2": "Cobran√ßa recebida",
              "operation": "notEquals"
            }
          ],
          "options": {}
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -768,
        -224
      ],
      "id": "83fae7c0-a2fc-4d68-977b-00ccf8617fa9",
      "name": "Follow-up ativo?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "6c5ff61e-c9da-4789-9de6-648ab9cd9e38",
              "leftValue": "={{ $json.conversa.last_non_activity_message.created_at.toDateTime('s') }}",
              "rightValue": "={{ $now.minus($('Info').item.json.follow_ups_horas[$('Buscar aguardando follow-up').item.json.numero_followup] || 24, 'hours') }}",
              "operator": {
                "type": "dateTime",
                "operation": "before"
              }
            },
            {
              "id": "fdd2432e-6dbd-4581-952b-6775af20615b",
              "leftValue": "={{ $('Buscar aguardando follow-up').item.json.numero_followup }}",
              "rightValue": "={{ $('Info').item.json.max_followups }}",
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -528,
        -320
      ],
      "id": "468e5dcb-4891-4b23-b650-2d7728adb980",
      "name": "Follow-up pendente?"
    },
    {
      "parameters": {
        "content": "## Aten√ß√£o!!\n\nS√≥ √© poss√≠vel fazer no m√°ximo 5 chamadas pelo WhatsApp para um mesmo contato em um per√≠odo de 24h.",
        "width": 304,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        528,
        -496
      ],
      "typeVersion": 1,
      "id": "86858124-a112-4faf-96cf-912ab8058cc7",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "errorMessage": "=Tipo follow-up configurado incorretamente. Use um desses valores:\n\n\"mensagem\"\n\"ligacao_whatsapp\"\n\"ligacao\""
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -144,
        -160
      ],
      "id": "8379c509-0c49-4fe2-9ba3-94f5aa850228",
      "name": "Tipo de follow-up inv√°lido"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "035a87e0-926f-4279-907d-3d749181c329",
              "leftValue": "={{ $('Buscar contato').item.json.contato.custom_attributes.permitir_chamadas_whatsapp }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        96,
        -304
      ],
      "id": "e03c31cf-6caa-4dca-9796-0f24719dc4ce",
      "name": "Contato j√° permitiu liga√ß√µes?"
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar aguardando follow-up": {
      "main": [
        [
          {
            "node": "83fae7c0-a2fc-4d68-977b-00ccf8617fa9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar mensagem": {
      "main": [
        [
          {
            "node": "d2f88187-8b4c-47c5-92c2-0e7bac95fc4a",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Desligar follow-up": {
      "main": [
        []
      ]
    },
    "Atualizar contagem follow-up": {
      "main": [
        []
      ]
    },
    "Desligar follow-up1": {
      "main": [
        [
          {
            "node": "017841bd-c31e-4197-9d82-6690b3b3a7b6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Follow-ups excedidos": {
      "main": [
        [
          {
            "node": "c399fdd7-ad32-4051-8933-4f9df6afa9f7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info": {
      "main": [
        [
          {
            "node": "f290bcf1-8f3d-4ec4-9091-e261fbd6f1f4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Desligar agente": {
      "main": [
        []
      ]
    },
    "OpenAI": {
      "ai_languageModel": [
        [
          {
            "node": "83b4ee86-df1b-425d-9c09-cd282b1c7fa6",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memoria": {
      "ai_memory": [
        [
          {
            "node": "83b4ee86-df1b-425d-9c09-cd282b1c7fa6",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Agente de Recupera√ß√£o de Leads": {
      "main": [
        [
          {
            "node": "72c60ecb-77f1-4a0b-b7bd-e8b2a5f057d9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Follow-up ativo?": {
      "main": [
        [
          {
            "node": "468e5dcb-4891-4b23-b650-2d7728adb980",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "c3d4a265-5f93-4cdf-92c1-9efa6890415d",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Follow-up pendente?": {
      "main": [
        [],
        [
          {
            "node": "e03c31cf-6caa-4dca-9796-0f24719dc4ce",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de follow-up inv√°lido": {
      "main": [
        []
      ]
    },
    "Contato j√° permitiu liga√ß√µes?": {
      "main": [
        [
          {
            "node": "83b4ee86-df1b-425d-9c09-cd282b1c7fa6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "df5e70c19307b561c5bfb8a52bd0a2d7fb241c90f71a892f0a6309b32288ea37"
  }
}
