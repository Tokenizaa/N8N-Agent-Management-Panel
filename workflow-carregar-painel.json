
{
  "name": "[PAINEL] Carregar Dados da Interface",
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "path": "load-panel-data",
        "options": {}
      },
      "name": "Webhook (GET)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        450,
        300
      ],
      "webhookId": "b1a2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT waitTime, notificationTrigger, notificationNumbers, is_active FROM agent_config LIMIT 1;"
      },
      "name": "DB: Get Agent Config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        680,
        20
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_DB_CREDENTIALS_ID",
          "name": "Postgres credentials"
        }
      },
      "notes": "Conecte às suas credenciais do Supabase/Postgres.\\n\\nPara o Supabase, vá em Project Settings > Database > Connection string e use os detalhes do 'URI'."
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM follow_up_cadences ORDER BY id ASC;"
      },
      "name": "DB: Get Follow-ups",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        680,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_DB_CREDENTIALS_ID",
          "name": "Postgres credentials"
        }
      },
      "notes": "Conecte às suas credenciais do Supabase/Postgres.\\n\\nPara o Supabase, vá em Project Settings > Database > Connection string e use os detalhes do 'URI'."
    },
    {
      "parameters": {
        "jsCode": "const config = $items('DB: Get Agent Config')[0].json; \nconst followUps = $items('DB: Get Follow-ups').map(item => item.json);\nconst statusJson = $items('Baileys: Check Status')[0].json;\nconst agentsRaw = $items('DB: Get Agents').map(item => item.json);\n\n// Pega os dados do dashboard do nó correto (IF ou seu fallback)\nconst dashboardNode = $items('IF: Range = this_month').length > 0 ? $items('DB: Get Dashboard Data (This Month)') : $items('DB: Get Dashboard Data (Default)');\nconst dashboard = dashboardNode[0].json;\n\nconst statuses = ['online', 'busy', 'offline'];\nconst agents = agentsRaw.map((agent, index) => ({\n    ...agent,\n    available_tools: agent.available_tools || [],\n    enable_follow_up: agent.enable_follow_up ?? false,\n    status: statuses[index % statuses.length] // Mock status for UI\n}));\n\n// Formata os dados para o frontend\nconst formattedData = {\n  agentConfig: {\n    waitTime: config.waitTime,\n    notificationTrigger: config.notificationTrigger,\n    notificationNumbers: config.notificationNumbers,\n    is_active: config.is_active\n  },\n  agents: agents,\n  followUpCadences: followUps,\n  dashboardData: {\n      kpis: {\n          totalLeads: Number(dashboard.total_leads) || 0,\n          totalCompras: Number(dashboard.total_compras) || 0,\n          totalFaturado: Number(dashboard.total_faturado) || 0,\n          ticketMedio: Number(dashboard.ticket_medio) || 0,\n          taxaConversao: Number(dashboard.taxa_conversao) || 0\n      },\n      leadsPorDia: [\n          { name: 'Seg', leads: 4 },\n          { name: 'Ter', leads: 3 },\n          { name: 'Qua', leads: 2 },\n          { name: 'Qui', leads: 2 },\n          { name: 'Sex', leads: 1 },\n          { name: 'Sáb', leads: 2 },\n          { name: 'Dom', leads: 3 },\n      ],\n      leadDetails: {\n          compras: [\n              { id: 'L001', name: 'João Silva', value: 250.00, date: '2024-07-20', agent: 'Assistente de Vendas' },\n              { id: 'L003', name: 'Maria Oliveira', value: 450.50, date: '2024-07-19', agent: 'Assistente de Vendas' },\n              { id: 'L005', name: 'Pedro Alves', value: 150.00, date: '2024-07-18', agent: 'Assistente de Vendas' }\n          ],\n          leads: [\n              { id: 'L001', name: 'João Silva', value: 0, date: '2024-07-20', agent: 'Secretária' },\n              { id: 'L002', name: 'Carlos Pereira', value: 0, date: '2024-07-20', agent: 'Secretária' },\n              { id: 'L003', name: 'Maria Oliveira', value: 0, date: '2024-07-19', agent: 'Secretária' },\n              { id: 'L004', name: 'Ana Costa', value: 0, date: '2024-07-18', agent: 'Secretária' }\n          ]\n      }\n  },\n  isWhatsAppConnected: statusJson.data?.status === 'CONNECTED'\n};\n\nreturn formattedData;"
      },
      "name": "Format Data for FE",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1560,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$node[\"Webhook (GET)\"].json.query.range}}",
              "value2": "this_month"
            }
          ]
        }
      },
      "name": "IF: Range = this_month",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        880,
        440
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \\n    COUNT(*) AS total_leads,\\n    SUM(CASE WHEN status = 'comprou' THEN 1 ELSE 0 END) AS total_compras,\\n    SUM(CASE WHEN status = 'comprou' THEN valor ELSE 0 END) AS total_faturado,\\n    AVG(CASE WHEN status = 'comprou' THEN valor ELSE NULL END) AS ticket_medio,\\n    (SUM(CASE WHEN status = 'comprou' THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS taxa_conversao\\nFROM \\n    leads\\nWHERE\\n    date_trunc('month', created_at) = date_trunc('month', NOW());"
      },
      "name": "DB: Get Dashboard Data (This Month)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        1120,
        440
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_DB_CREDENTIALS_ID",
          "name": "Postgres credentials"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \\n    COUNT(*) AS total_leads,\\n    SUM(CASE WHEN status = 'comprou' THEN 1 ELSE 0 END) AS total_compras,\\n    SUM(CASE WHEN status = 'comprou' THEN valor ELSE 0 END) AS total_faturado,\\n    AVG(CASE WHEN status = 'comprou' THEN valor ELSE NULL END) AS ticket_medio,\\n    (SUM(CASE WHEN status = 'comprou' THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0)) AS taxa_conversao\\nFROM \\n    leads\\nWHERE\\n    created_at >= NOW() - INTERVAL '{{$node[\"Webhook (GET)\"].json.query.range === '30d' ? '30' : '7'}} days';"
      },
      "name": "DB: Get Dashboard Data (Default)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        1120,
        600
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_DB_CREDENTIALS_ID",
          "name": "Postgres credentials"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.BAILEYS_API_URL}}/instance/status",
        "authentication": "headerAuth",
        "options": {
          "ignoreSslIssues": true
        }
      },
      "name": "Baileys: Check Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        680,
        -140
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_BAILEYS_API_KEY_ID",
          "name": "Baileys API Key"
        }
      },
      "notes": "Verifica o status da conexão da instância Baileys.\\n\\n**Variáveis de Ambiente Necessárias:**\\n- `BAILEYS_API_URL`\\n\\n**Credenciais Necessárias:**\\n- Crie credenciais 'Header Auth' com:\\n  - Name: `apikey`\\n  - Value: [Sua API Key do Baileys]"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, name, description, prompt, is_default, is_active, available_tools, sort_order, enable_follow_up FROM agents ORDER BY sort_order ASC, id ASC;"
      },
      "name": "DB: Get Agents",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        680,
        160
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_DB_CREDENTIALS_ID",
          "name": "Postgres credentials"
        }
      }
    }
  ],
  "connections": {
    "Webhook (GET)": {
      "main": [
        [
          {
            "node": "DB: Get Agent Config",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB: Get Follow-ups",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF: Range = this_month",
            "type": "main",
            "index": 0
          },
          {
            "node": "Baileys: Check Status",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB: Get Agents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB: Get Agent Config": {
      "main": [
        [
          {
            "node": "Format Data for FE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB: Get Follow-ups": {
      "main": [
        [
          {
            "node": "Format Data for FE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Range = this_month": {
      "main": [
        [
          {
            "node": "DB: Get Dashboard Data (This Month)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DB: Get Dashboard Data (Default)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB: Get Dashboard Data (This Month)": {
      "main": [
        [
          {
            "node": "Format Data for FE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB: Get Dashboard Data (Default)": {
      "main": [
        [
          {
            "node": "Format Data for FE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Data for FE": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Baileys: Check Status": {
      "main": [
        [
          {
            "node": "Format Data for FE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB: Get Agents": {
      "main": [
        [
          {
            "node": "Format Data for FE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
